-- Moji Hub API Integration System
-- Version: 2.0.0
-- Description: à¸£à¸°à¸šà¸šà¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸›à¸¢à¸±à¸‡ Dashboard API
-- GitHub: https://github.com/MojiHIght/99Night

-- ======================================
-- API CONFIGURATION
-- ======================================
local API_CONFIG = {
    ENDPOINT = "http://localhost:3000/api/update",
    TEST_ENDPOINT = "http://localhost:3000/api/test",
    HEALTH_ENDPOINT = "http://localhost:3000/api/health",
    ENABLE_LOGGING = true,
    RETRY_ATTEMPTS = 3,
    UPDATE_INTERVAL = 10, -- à¸§à¸´à¸™à¸²à¸—à¸µ
    GLOBAL_UPDATE_INTERVAL = 30 -- à¸§à¸´à¸™à¸²à¸—à¸µ
}

-- ======================================
-- SERVICES
-- ======================================
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- ======================================
-- VARIABLES
-- ======================================
local isAPIEnabled = true
local lastUpdateTime = 0
local updateLoopActive = false

-- ======================================
-- HTTP FUNCTION DETECTION
-- ======================================
local function getHttpFunction()
    local functions = {
        {func = syn and syn.request, name = "syn.request", executor = "Synapse X"},
        {func = http and http.request, name = "http.request", executor = "Script-Ware"},
        {func = http_request, name = "http_request", executor = "Krnl"},
        {func = request, name = "request", executor = "Generic"}
    }
    
    for _, httpFunc in pairs(functions) do
        if httpFunc.func then
            if API_CONFIG.ENABLE_LOGGING then
                print("[API] à¹ƒà¸Šà¹‰ HTTP function:", httpFunc.name, "(" .. httpFunc.executor .. ")")
            end
            return httpFunc.func
        end
    end
    
    return nil
end

-- ======================================
-- DIAMOND DETECTION SYSTEM
-- ======================================
local function getCurrentDiamonds()
    local success, count = pcall(function()
        local player = LocalPlayer
        
        -- Method 1: leaderstats (à¹à¸™à¸°à¸™à¸³)
        local leaderstats = player:FindFirstChild("leaderstats")
        if leaderstats then
            local diamondStats = {
                leaderstats:FindFirstChild("Diamonds"),
                leaderstats:FindFirstChild("diamonds"),
                leaderstats:FindFirstChild("Diamond"),
                leaderstats:FindFirstChild("Gems"),
                leaderstats:FindFirstChild("gems"),
                leaderstats:FindFirstChild("Money"),
                leaderstats:FindFirstChild("Cash")
            }
            
            for _, stat in pairs(diamondStats) do
                if stat and stat.Value then
                    local value = tonumber(stat.Value)
                    if value and value > 0 then
                        return value
                    end
                end
            end
        end
        
        -- Method 2: Player Attributes
        local attributes = {
            "Diamonds", "diamonds", "Diamond", "Gems", "gems", "Money", "Cash"
        }
        
        for _, attr in pairs(attributes) do
            local value = player:GetAttribute(attr)
            if value and tonumber(value) and tonumber(value) > 0 then
                return tonumber(value)
            end
        end
        
        -- Method 3: Character Attributes
        if player.Character then
            for _, attr in pairs(attributes) do
                local value = player.Character:GetAttribute(attr)
                if value and tonumber(value) and tonumber(value) > 0 then
                    return tonumber(value)
                end
            end
        end
        
        -- Method 4: PlayerGui Text Scanning
        local playerGui = player:FindFirstChild("PlayerGui")
        if playerGui then
            for _, gui in pairs(playerGui:GetDescendants()) do
                if gui:IsA("TextLabel") or gui:IsA("TextButton") then
                    local text = gui.Text:lower()
                    if string.find(text, "diamond") or string.find(text, "gem") or string.find(text, "money") then
                        -- à¸«à¸²à¸•à¸±à¸§à¹€à¸¥à¸‚à¹ƒà¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡
                        local numbers = {}
                        for number in string.gmatch(gui.Text, "%d+") do
                            local num = tonumber(number)
                            if num and num > 0 and num < 999999999 then -- à¸›à¹‰à¸­à¸‡à¸à¸±à¸™à¸•à¸±à¸§à¹€à¸¥à¸‚à¹ƒà¸«à¸à¹ˆà¹€à¸à¸´à¸™à¹„à¸›
                                table.insert(numbers, num)
                            end
                        end
                        
                        if #numbers > 0 then
                            -- à¸„à¸·à¸™à¸„à¹ˆà¸²à¸•à¸±à¸§à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¹ƒà¸«à¸à¹ˆà¸—à¸µà¹ˆà¸ªà¸¸à¸” (à¸™à¹ˆà¸²à¸ˆà¸°à¹€à¸›à¹‡à¸™ diamonds)
                            return math.max(unpack(numbers))
                        end
                    end
                end
            end
        end
        
        -- Method 5: DataStores (experimental)
        local success2, result = pcall(function()
            local dataStoreService = game:GetService("DataStoreService")
            if dataStoreService then
                -- à¸¥à¸­à¸‡à¸«à¸²à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ DataStore (à¸­à¸²à¸ˆà¹„à¸¡à¹ˆà¸—à¸³à¸‡à¸²à¸™à¹ƒà¸™ executor à¸šà¸²à¸‡à¸•à¸±à¸§)
                return 0
            end
        end)
        
        return 0
    end)
    
    return success and count or 0
end

-- ======================================
-- API COMMUNICATION
-- ======================================
local function sendRequest(url, data, method)
    local requestFunc = getHttpFunction()
    if not requestFunc then
        if API_CONFIG.ENABLE_LOGGING then
            warn("[API] à¹„à¸¡à¹ˆà¸à¸š HTTP request function à¸—à¸µà¹ˆà¸£à¸­à¸‡à¸£à¸±à¸š")
        end
        return false, "No HTTP function available"
    end
    
    local success, result = pcall(function()
        local requestData = {
            Url = url,
            Method = method or "POST",
            Headers = {
                ["Content-Type"] = "application/json",
                ["User-Agent"] = "Roblox-MojiHub/2.0.0",
                ["Accept"] = "application/json"
            }
        }
        
        if data then
            requestData.Body = HttpService:JSONEncode(data)
        end
        
        local response = requestFunc(requestData)
        
        if response.StatusCode >= 200 and response.StatusCode < 300 then
            return true, response
        else
            return false, "HTTP " .. response.StatusCode .. ": " .. (response.Body or "Unknown error")
        end
    end)
    
    if not success then
        return false, result
    end
    
    return result
end

-- ======================================
-- API FUNCTIONS
-- ======================================

-- à¸—à¸”à¸ªà¸­à¸šà¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ API
local function testAPIConnection()
    local testData = {
        username = LocalPlayer.Name,
        status = "Testing Connection",
        diamonds = 0,
        lastUpdated = os.time(),
        test = true,
        version = "2.0.0"
    }
    
    local success, response = sendRequest(API_CONFIG.TEST_ENDPOINT, testData)
    
    if success and API_CONFIG.ENABLE_LOGGING then
        print("[API] à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸šà¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸ªà¸³à¹€à¸£à¹‡à¸ˆ")
    elseif not success and API_CONFIG.ENABLE_LOGGING then
        warn("[API] à¸à¸²à¸£à¸—à¸”à¸ªà¸­à¸šà¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§:", response)
    end
    
    return success
end

-- à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸ªà¸¸à¸‚à¸ à¸²à¸à¸‚à¸­à¸‡ server
local function checkServerHealth()
    local success, response = sendRequest(API_CONFIG.HEALTH_ENDPOINT, nil, "GET")
    
    if success and API_CONFIG.ENABLE_LOGGING then
        print("[API] Server à¸—à¸³à¸‡à¸²à¸™à¸›à¸à¸•à¸´")
    end
    
    return success
end

-- à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹„à¸›à¸¢à¸±à¸‡ API
local function sendUserData(status, diamonds, extraData)
    extraData = extraData or {}
    
    local data = {
        username = LocalPlayer.Name,
        status = status or "Unknown",
        diamonds = diamonds or getCurrentDiamonds(),
        lastUpdated = os.time(),
        timestamp = os.date("%Y-%m-%dT%H:%M:%SZ"),
        placeId = game.PlaceId,
        jobId = game.JobId,
        version = "2.0.0"
    }
    
    -- à¸£à¸§à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡
    for key, value in pairs(extraData) do
        data[key] = value
    end
    
    local success, response = sendRequest(API_CONFIG.ENDPOINT, data)
    
    if success then
        lastUpdateTime = os.time()
        if API_CONFIG.ENABLE_LOGGING then
            print("[API] à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸³à¹€à¸£à¹‡à¸ˆ:", data.username, "-", data.status, "-", data.diamonds, "diamonds")
        end
    else
        if API_CONFIG.ENABLE_LOGGING then
            warn("[API] à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§:", response)
        end
    end
    
    return success
end

-- à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸–à¸²à¸™à¸° (à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸«à¸¥à¸±à¸)
local function updateStatus(status, diamonds, extraData)
    if not isAPIEnabled then return false end
    
    local currentDiamonds = diamonds or getCurrentDiamonds()
    
    -- à¸¥à¸­à¸‡à¸ªà¹ˆà¸‡à¸«à¸¥à¸²à¸¢à¸„à¸£à¸±à¹‰à¸‡à¸«à¸²à¸à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§
    for attempt = 1, API_CONFIG.RETRY_ATTEMPTS do
        local success = sendUserData(status, currentDiamonds, extraData)
        
        if success then
            return true
        else
            if attempt < API_CONFIG.RETRY_ATTEMPTS then
                if API_CONFIG.ENABLE_LOGGING then
                    warn("[API] à¸¥à¸­à¸‡à¸ªà¹ˆà¸‡à¹ƒà¸«à¸¡à¹ˆà¸„à¸£à¸±à¹‰à¸‡à¸—à¸µà¹ˆ", attempt + 1, "/", API_CONFIG.RETRY_ATTEMPTS)
                end
                wait(1) -- à¸£à¸­ 1 à¸§à¸´à¸™à¸²à¸—à¸µà¸à¹ˆà¸­à¸™à¸¥à¸­à¸‡à¹ƒà¸«à¸¡à¹ˆ
            end
        end
    end
    
    if API_CONFIG.ENABLE_LOGGING then
        warn("[API] à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¹‰à¸¡à¹€à¸«à¸¥à¸§à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸¥à¸­à¸‡", API_CONFIG.RETRY_ATTEMPTS, "à¸„à¸£à¸±à¹‰à¸‡")
    end
    
    return false
end

-- ======================================
-- AUTO UPDATE SYSTEM
-- ======================================
local currentStatus = "Unknown"
local statusUpdateCallback = nil

-- à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸°à¸šà¸šà¸­à¸±à¸›à¹€à¸”à¸•à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
local function startAutoUpdate(interval)
    interval = interval or API_CONFIG.UPDATE_INTERVAL
    updateLoopActive = true
    
    spawn(function()
        while updateLoopActive do
            if isAPIEnabled and currentStatus then
                updateStatus(currentStatus)
            end
            wait(interval)
        end
    end)
    
    if API_CONFIG.ENABLE_LOGGING then
        print("[API] à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸°à¸šà¸šà¸­à¸±à¸›à¹€à¸”à¸•à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´ (à¸—à¸¸à¸", interval, "à¸§à¸´à¸™à¸²à¸—à¸µ)")
    end
end

-- à¸«à¸¢à¸¸à¸”à¸£à¸°à¸šà¸šà¸­à¸±à¸›à¹€à¸”à¸•à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
local function stopAutoUpdate()
    updateLoopActive = false
    if API_CONFIG.ENABLE_LOGGING then
        print("[API] à¸«à¸¢à¸¸à¸”à¸£à¸°à¸šà¸šà¸­à¸±à¸›à¹€à¸”à¸•à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´")
    end
end

-- à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² callback à¸ªà¸³à¸«à¸£à¸±à¸š status update
local function setStatusCallback(callback)
    statusUpdateCallback = callback
end

-- à¸­à¸±à¸›à¹€à¸”à¸•à¸ªà¸–à¸²à¸™à¸°à¸›à¸±à¸ˆà¸ˆà¸¸à¸šà¸±à¸™
local function setCurrentStatus(status)
    currentStatus = status
    if statusUpdateCallback then
        statusUpdateCallback(status)
    end
end

-- ======================================
-- UTILITY FUNCTIONS
-- ======================================

-- à¸£à¸µà¹€à¸‹à¹‡à¸•à¸£à¸°à¸šà¸š API
local function resetAPI()
    stopAutoUpdate()
    currentStatus = "Unknown"
    lastUpdateTime = 0
    
    spawn(function()
        wait(2)
        if testAPIConnection() then
            updateStatus("Connected")
            startAutoUpdate()
        else
            updateStatus("Offline")
        end
    end)
    
    if API_CONFIG.ENABLE_LOGGING then
        print("[API] à¸£à¸µà¹€à¸‹à¹‡à¸•à¸£à¸°à¸šà¸š API")
    end
end

-- à¹€à¸›à¸´à¸”/à¸›à¸´à¸”à¸£à¸°à¸šà¸š API
local function toggleAPI(enabled)
    isAPIEnabled = enabled
    
    if enabled then
        if API_CONFIG.ENABLE_LOGGING then
            print("[API] à¹€à¸›à¸´à¸”à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸£à¸°à¸šà¸š API")
        end
        if not updateLoopActive then
            startAutoUpdate()
        end
    else
        if API_CONFIG.ENABLE_LOGGING then
            print("[API] à¸›à¸´à¸”à¹ƒà¸Šà¹‰à¸‡à¸²à¸™à¸£à¸°à¸šà¸š API")
        end
        stopAutoUpdate()
    end
end

-- à¸”à¸¹à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸–à¸²à¸™à¸° API
local function getAPIStatus()
    return {
        enabled = isAPIEnabled,
        autoUpdateActive = updateLoopActive,
        currentStatus = currentStatus,
        lastUpdateTime = lastUpdateTime,
        currentDiamonds = getCurrentDiamonds(),
        httpFunctionAvailable = getHttpFunction() ~= nil
    }
end

-- à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²
local function setConfig(key, value)
    if API_CONFIG[key] ~= nil then
        API_CONFIG[key] = value
        if API_CONFIG.ENABLE_LOGGING then
            print("[API] à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸à¸²à¸£à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²", key, "à¹€à¸›à¹‡à¸™", value)
        end
        return true
    end
    return false
end

-- ======================================
-- INITIALIZATION
-- ======================================
local function initializeAPI()
    if API_CONFIG.ENABLE_LOGGING then
        print("=================================")
        print("ğŸš€ Moji Hub API System v2.0.0")
        print("ğŸ‘¤ à¸œà¸¹à¹‰à¹€à¸¥à¹ˆà¸™:", LocalPlayer.Name)
        print("ğŸ  Place ID:", game.PlaceId)
        print("ğŸ”§ Job ID:", game.JobId)
        print("=================================")
    end
    
    -- à¸—à¸”à¸ªà¸­à¸šà¸à¸²à¸£à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
    spawn(function()
        wait(2) -- à¸£à¸­à¹ƒà¸«à¹‰à¹€à¸à¸¡à¹‚à¸«à¸¥à¸”
        
        updateStatus("Loading")
        wait(1)
        
        if testAPIConnection() then
            updateStatus("Connected")
            if API_CONFIG.ENABLE_LOGGING then
                print("[API] à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ API à¸ªà¸³à¹€à¸£à¹‡à¸ˆ")
            end
        else
            updateStatus("Offline")
            if API_CONFIG.ENABLE_LOGGING then
                warn("[API] à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸Šà¸·à¹ˆà¸­à¸¡à¸•à¹ˆà¸­ API à¹„à¸”à¹‰")
                print("[API] à¸à¸£à¸¸à¸“à¸²à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸š:")
                print("   1. à¹€à¸‹à¸´à¸£à¹Œà¸Ÿà¹€à¸§à¸­à¸£à¹Œ Node.js à¸—à¸³à¸‡à¸²à¸™à¸­à¸¢à¸¹à¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ")
                print("   2. à¸à¸­à¸£à¹Œà¸• 3000 à¹€à¸›à¸´à¸”à¸­à¸¢à¸¹à¹ˆà¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ")
                print("   3. Executor à¸£à¸­à¸‡à¸£à¸±à¸š HTTP requests à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ")
            end
        end
        
        -- à¹€à¸£à¸´à¹ˆà¸¡à¸£à¸°à¸šà¸šà¸­à¸±à¸›à¹€à¸”à¸•à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´
        startAutoUpdate()
    end)
end

-- ======================================
-- GLOBAL EXPORTS
-- ======================================

-- à¸ªà¹ˆà¸‡à¸­à¸­à¸à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¸ªà¸³à¸„à¸±à¸à¹„à¸›à¸¢à¸±à¸‡ _G
_G.MojiAPI = {
    -- Core functions
    updateStatus = updateStatus,
    getCurrentDiamonds = getCurrentDiamonds,
    testConnection = testAPIConnection,
    checkHealth = checkServerHealth,
    
    -- Control functions
    startAutoUpdate = startAutoUpdate,
    stopAutoUpdate = stopAutoUpdate,
    resetAPI = resetAPI,
    toggleAPI = toggleAPI,
    
    -- Status functions
    setCurrentStatus = setCurrentStatus,
    setStatusCallback = setStatusCallback,
    getAPIStatus = getAPIStatus,
    
    -- Configuration
    setConfig = setConfig,
    getConfig = function() return API_CONFIG end,
    
    -- Utility
    sendUserData = sendUserData,
    getHttpFunction = getHttpFunction
}

-- Export individual functions (backward compatibility)
_G.updateStatus = updateStatus
_G.getCurrentDiamonds = getCurrentDiamonds
_G.testAPI = testAPIConnection

-- ======================================
-- AUTO INITIALIZATION
-- ======================================
initializeAPI()

-- Global status update loop (backup)
spawn(function()
    while true do
        wait(API_CONFIG.GLOBAL_UPDATE_INTERVAL)
        
        if isAPIEnabled and currentStatus and currentStatus ~= "Unknown" then
            updateStatus(currentStatus)
        end
    end
end)

if API_CONFIG.ENABLE_LOGGING then
    print("[API] à¸£à¸°à¸šà¸š API à¸à¸£à¹‰à¸­à¸¡à¹ƒà¸Šà¹‰à¸‡à¸²à¸™")
    print("[API] à¹ƒà¸Šà¹‰ _G.MojiAPI à¹€à¸à¸·à¹ˆà¸­à¹€à¸‚à¹‰à¸²à¸–à¸¶à¸‡à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™")
    print("=================================")
end
